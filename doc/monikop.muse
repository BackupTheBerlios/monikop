#title Monikop and Pokinom
#subtitle rsync from unconnected hosts

* Purpose

Suppose we have an isolated network of data producing computers
(Sources), e.g. in a surveying vehicle (Rover). The collected data (a
few Terabytes per day) need to be transferred to a processing server
(Destination) in office.

This data transfer, which happens by means of removable disks, is our
job.

On Rover, a couple of removable disks are put into a dedicated computer where they are
filled automatically by Monikop with data pulled from Sources.

The disks are then carried to the office where they are put into another
dedicated computer. Here, Monikop's counterpart called Pokinom pushes
their content to Destination and makes the disks re-usable by
Monikop. 

The heavy lifting is done by [[http://www.samba.org/rsync/][rsync]]. Sources as well as Destination
need to have rsync servers installed.

 - Transfer rates ca. ...


* Installation

** Packages

For Debian, use

 - to install from a git repository: git-core;

 - to run Monikop or Pokinom: 
   rsync, mingetty, sudo, libcurses-perl, libfile-rsync-perl,
   mingetty;

 - to run the tests: bc, time.


** Prepare Removable Disks

*** File Systems

Create Filesystems with labels for the removable disks. Example
(suppose a removable disk tagged =disk_10= is attached to =/dev/sdg1=): 

=mke2fs -j -L disk_10 /dev/sdg1=

Label the system partition. If it were on =/dev/sda1/=:

=e2label /dev/sda1 root=

Label the swap partition. If it happens to be on /dev/sda5:

=swapoff=

=mkswap -L swap /dev/sda5=

=swapon=
 
*** Mount Points

Create mount points, one for each removable disk:

=mkdir -p /media/disk_{01,02,03}= etc.

=chmod a+rx /media/disk_{01,02,03}= etc.

In =/etc/fstab=, make use of the disk labels:

<src lang="conf">
## System partitions ###
LABEL=root     /               ext3  defaults,errors=remount-ro 0  1
LABEL=swap     none            swap  sw                         0  0
## Removable disks                   
LABEL=disk_01  /media/disk_01  ext3  rw,user,auto               0  0
LABEL=disk_02  /media/disk_02  ext3  rw,user,auto               0  0
LABEL=disk_03  /media/disk_03  ext3  rw,user,auto               0  0
# etc.
</src>

Put each removable disk in and make it writable:

=mount /media/disk_01=

=chmod a+rwx /media/disk_01=
 
** Maintain Bootability

Make sure the system boots actually from its system disk rather than from
some of the removable ones. Change =/boot/grub/menu.lst= where it says

<code># kopt=root=...</code>:

<src lang="conf">
### BEGIN AUTOMAGIC KERNELS LIST
## lines between the AUTOMAGIC KERNELS LIST markers will be modified
## by the debian update-grub script except for the default options below

## DO NOT UNCOMMENT THEM, Just edit them to your needs

## ## Start Default Options ##
## default kernel options
## default kernel options for automagic boot options
## If you want special options for specific kernels use kopt_x_y_z
## where x.y.z is kernel version. Minor versions can be omitted.
## e.g. kopt=root=/dev/hda1 ro
##      kopt_2_6_8=root=/dev/hdc1 ro
##      kopt_2_6_8_2_686=root=/dev/hdc2 ro
# kopt=root=/dev/disk/by-label/root noresume ro
</src>
 
and call
 
=update-grub=


** Automatic Login

=/etc/inittab=: change line which says

<src lang="conf">
1:2345:respawn:/sbin/getty 38400 tty1
</src>

into

<src lang="conf">
1:2345:respawn:/sbin/mingetty --autologin m-operator --noclear tty1
</src>


** Install Monikop and Pokinom

Create a user on both Monikop's and Pokinom's machine. For
description's sake, we assume they're called m-operator.

Get Monikop (and Pokinom); from m-operator's home directory say:

=git-clone (FIXME: repo here)=

Copy =monikop.config.example= to =monikop.config= and
=pokinom.config.example= to =pokinom.config= and
adapt them according to your needs. Both have helpful comments,
and both are perl code, so be careful and keep the interpunction
in place. 

Things you want to change for Monikop in =monikop.config=:

<src lang="perl">
# Possible data sources, and by what directory name to represent them in
# destination.
# When the latter is not unique, care must be taken that all pathnames in the 
# respective sources are unique.
%sources = (
    'data_producer1::data' => 'p1',
    'data_producer2::data' => 'p2',
    'data_producer3::data' => '',
    'data_producer4::data' => '',
    );

# Possible mount points of data destinations.
@usable_mount_points = (
    '/media/disk_1',
    '/media/disk_2',
    '/media/disk_3',
    );
</src>

=%sources= are the data producing Sources in a format rsync
understands, together with a source-specific directory name where data
of the respective Source goes. Those directory names can be equal for
several Sources if all filenames in the payload are certain to be
unique.

=@usable_mount_points= are mount points (directories) you set up for your
removable disks.
   
Things you want to change accordingly for Pokinom in =pokinom.config=:

<src lang="perl">
# Possible mount points.
@usable_mount_points = (
    '/media/disk_1',
    '/media/disk_2',
    '/media/disk_3',
    );
</src>

*** Autostart

Append to =~/.profile= (create if necessary):

<src lang="bash">
/home/m-operator/monikop/monikop
</src>

or

<src lang="bash">
/home/m-operator/monikop/pokinom,
respectively.
</src>

If necessary, specify path to config file, e.g.  
<src lang="bash">
/home/m-operator/monikop/monikop /home/m-operator/monikop/monikop.config
</src>


*** Setup Sudo

Authorize m-operator to shut down computer.
Use =visudo= to change =/etc/sudoers=; add:

<src lang="conf">
messung ALL=(ALL) NOPASSWD: /sbin/halt -p
messung ALL=(ALL) NOPASSWD: /sbin/reboot
</src>



** Configure Rsync on Sources

Install package rsync.

Example for =/etc/rsyncd.conf=:

<src lang="conf">
pid file=/var/run/rsyncd.pid
[data]
    path = /mnt/hdd_0
    use chroot = false
    lock file = /var/lock/rsyncd
    read only = yes
    list = yes
    transfer logging = false
</src>

In =/etc/default/rsync=, change a line from

<src lang="conf">
RSYNC_ENABLE = false
</src>

to

<src lang="conf">
RSYNC_ENABLE = true
</src>

Start rsync server:

=/etc/initd/rsync start=

or reboot.


On Windows, install
[[http://sourceforge.net/projects/sereds/files/cwRsync/4.0.3/cwRsyncServer_4.0.3_Installer.zip/download][cwRsync]]. Click
Start, Programs, cwRsyncServer, rsyncd.conf; edit:

<src lang="conf">
use chroot = false
strict modes = false
hosts allow = *
logfile = rsyncd.log
[data]
#   /cygdrive/e/log stands for E:\log
    path = /cygdrive/e/log
    read only = false
    transfer logging = false
</src>

Configure service rsync for automatic start.


** Network setup

Depending on the amount of data to transfer, consider putting a dedicated NIC for each Source into Monikop's machine.
In this case, you should provide for non-overlapping
subnets. [[http://jodies.de/ipcalc][IP-Calculator]] may be helpful.

*** Monikop


**** Name the Sources

Example for =/etc/hosts=:

<src lang="conf">
127.0.0.1      localhost
192.168.200.10 data-producer1
192.168.200.20 data-producer2
192.168.200.30 data-producer3
192.168.200.50 data-producer4
192.168.178.1  monikop
</src>


**** Configure NICs

Example for =/etc/network/interfaces=:
<src lang="conf">
# The loopback network interface
auto lo
iface lo inet loopback

# Net of smaller Sources
allow-hotplug eth1
iface eth1 inet static
   address 192.168.178.1
   netmask 255.255.255.0

# Dedicated NIC for data-producer1
allow-hotplug eth2
iface eth2 inet static
   address 192.168.200.9
   netmask 255.255.255.248

# Dedicated NIC for data_producer2
allow-hotplug eth3
iface eth3 inet static
   address 192.168.200.19
   netmask 255.255.255.248

# Dedicated NIC for data_producer3
allow-hotplug eth4
iface eth4 inet static
   address 192.168.200.29
   netmask 255.255.255.248

# Dedicated NIC for data_producer4
allow-hotplug eth5
iface eth5 inet static
   address 192.168.200.49
   netmask 255.255.255.248
</src>


*** Data Sources


Use =/etc/hosts= as for Monikop. For Windows, it's =%SystemRoot%\system32\drivers\etc\hosts=.

**** Source's NIC

Example for =/etc/network/interfaces=:

<src lang="conf">
auto lo
iface lo inet loopback

# service (not relevant for Monikop)
allow-hotplug eth0
iface eth0 inet static
   address 192.168.178.2
   netmask 255.255.255.0

# Monikop's dedicated NIC
allow-hotplug eth1
iface eth1 inet static
   address 192.168.200.10
   netmask 255.255.255.248
</src>

For Windows, configure your network settings accordingly.


** Pokinom
** fsck-pokinom
** Data destination

+** Rsync server installation

- Linux

=/etc/default/rsync=:
Change line from
<src lang="conf">
RSYNC_ENABLE = false
</src>
to
<src lang="conf">
RSYNC_ENABLE = true
</src>
=/etc/rsyncd.conf:=

<src lang="conf">
 gid = str_db1_media
 use chroot = yes
 max connections = 0
 pid file = /var/run/rsyncd.pid
 
 [media]
         path = /mnt/./data0
         list = no
         comment = Pokinom only (requires authentication)
         read only = no
         incoming chmod = g+r,g+w
         write only = yes
         # Pokinom's IP:
         hosts allow = 192.168.180.120
         auth users = m-operator
         secrets file = /etc/rsyncd.secrets
</src>

=/etc/rsyncd.secrets=:

<src lang="conf">
m-operator:seCreT
</src>


- Windows

install cwrsync:
http://sourceforge.net/projects/sereds/files/cwRsync/4.0.3/cwRsyncServer_4.0.3_Installer.zip/download
rsyncd.conf
Service rsync: autostart

* Usage

   - You have to be able to tell from your data if it's complete.
   - Monikop shows which disks have data and therefore should be
     transferred to Pokinom.
   - Monikop keeps starting over until shutdown or until disappearance
     or data source(s)
   - Pokinom needs sufficient amount of free space on sink; must be
     rebooted once this is not the case.
   - fsck-monikop: to be run by root
   - Backup functionality: data remains on disks until re-inserted in
     Monikop. Names in use.

* Bugs

  - Data must not contain any directories called $rsync_partial_dir_name
  - Doesn't reflect disappearance of files on sources
  - May ignore empty dirs (really?)
   
* License

